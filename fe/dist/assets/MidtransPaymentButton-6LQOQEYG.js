import{c as h,j as a,r as l,B as x,t as b,ag as S}from"./index-NjOUpROL.js";import{o as k}from"./orderApi-Bf7iDseh.js";import{u as j}from"./useCurrencyConversion-B0EAKHYj.js";import{A as m}from"./Alert-B1gb4VHd.js";const P=h(a.jsx("path",{d:"M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2m0 14H4v-6h16zm0-10H4V6h16z"}),"CreditCard"),C=()=>{const[p,i]=l.useState(!1),[n,o]=l.useState(!1),[c,t]=l.useState(null);return l.useEffect(()=>{(async()=>{if(window.snap){i(!0);return}if(!n){o(!0),t(null);try{const r=document.createElement("script");r.src="https://app.sandbox.midtrans.com/snap/snap.js",r.setAttribute("data-client-key","SB-Mid-client-UtRW_uI4F5Wz6Pv8Tq8TQ"),r.onload=()=>{i(!0),o(!1)},r.onerror=()=>{t("Failed to load Snap script"),o(!1)},document.head.appendChild(r)}catch{t("Failed to load Snap script"),o(!1)}}})()},[n]),{isLoaded:p,isLoading:n,error:c}};function I({order:p,onSuccess:i,onError:n,paymentMethod:o="bank_transfer"}){const[c,t]=l.useState(!1),{isLoaded:d,isLoading:r,error:u}=C(),{loading:y,error:g}=j(),f=async()=>{try{if(t(!0),console.log("Snap script status:",{isLoaded:d,isLoading:r,snapError:u}),console.log("Window.snap available:",!!window.snap),!d){n("Snap script belum dimuat. Silakan coba lagi.");return}if(!window.snap){n("Snap script tidak tersedia. Silakan refresh halaman.");return}const e=await k.createMidtransPayment(p.id,o);console.log("Create payment response:",e),e.success?(console.log("Payment token:",e.data.token),console.log("Token length:",e.data.token.length),console.log("Is existing payment:",e.data.is_existing),window.snap.pay(e.data.token,{onSuccess:s=>{console.log("Payment success:",s),i(s)},onPending:s=>{console.log("Payment pending:",s),i(s)},onError:s=>{console.log("Payment error:",s),n("Pembayaran gagal: "+(s.message||"Unknown error"))},onClose:()=>{console.log("Payment popup closed"),t(!1)}})):(console.log("Payment creation failed:",e.error),n(e.error||"Gagal membuat pembayaran Midtrans"))}catch(e){if(console.error("Midtrans payment error:",e),e.response?.data?.error?.includes("Payment session already exists")){console.log("Payment session already exists - this should not happen with new logic"),n("Sesi pembayaran sudah ada. Silakan coba lagi.");return}n(e.response?.data?.error||"Gagal membuat pembayaran Midtrans")}finally{t(!1)}};return u?a.jsxs(m,{severity:"error",sx:{mb:3},children:[a.jsx("strong",{children:"Error Loading Snap Script"}),a.jsx("br",{}),u]}):y?a.jsxs(m,{severity:"info",sx:{mb:3},children:[a.jsx("strong",{children:"Memuat Kurs Mata Uang..."}),a.jsx("br",{}),"Sedang memuat kurs mata uang untuk pembayaran."]}):g?a.jsxs(m,{severity:"error",sx:{mb:3},children:[a.jsx("strong",{children:"Error Kurs Mata Uang"}),a.jsx("br",{}),g]}):a.jsx(x,{children:a.jsx(b,{variant:"contained",size:"large",startIcon:c||r?a.jsx(S,{size:20,color:"inherit"}):a.jsx(P,{}),onClick:f,disabled:c||r||!d,fullWidth:!0,sx:{py:1.5,borderRadius:2,fontWeight:600,fontSize:"1rem",backgroundColor:"primary.main","&:hover":{backgroundColor:"primary.dark"},"&:disabled":{backgroundColor:"grey.300",color:"grey.500"}},children:c?"Memproses Pembayaran...":r?"Memuat Snap Script...":"Bayar dengan Midtrans"})})}export{P as C,I as M};
