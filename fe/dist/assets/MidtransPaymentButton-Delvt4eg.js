import{c as x,j as e,r as d,B as b,v as S,O as k}from"./index-tvCmUXkA.js";import{o as y}from"./orderApi-BOQ5SOkY.js";import{u as P}from"./useCurrencyConversion-DM705tyN.js";import{A as m}from"./Alert-iJ2nvuQL.js";const j=x(e.jsx("path",{d:"M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2m0 14H4v-6h16zm0-10H4V6h16z"}),"CreditCard"),w=()=>{const[t,l]=d.useState(!1),[s,o]=d.useState(!1),[c,i]=d.useState(null);return d.useEffect(()=>{(async()=>{if(window.snap){l(!0);return}if(!s){o(!0),i(null);try{const n=document.createElement("script");n.src="https://app.sandbox.midtrans.com/snap/snap.js",n.setAttribute("data-client-key","SB-Mid-client-UtRW_uI4F5Wz6Pv8Tq8TQ"),n.onload=()=>{l(!0),o(!1)},n.onerror=()=>{i("Failed to load Snap script"),o(!1)},document.head.appendChild(n)}catch{i("Failed to load Snap script"),o(!1)}}})()},[s]),{isLoaded:t,isLoading:s,error:c}};function I({order:t,onSuccess:l,onError:s,paymentMethod:o="bank_transfer"}){const[c,i]=d.useState(!1),{isLoaded:p,isLoading:n,error:u}=w(),{loading:f,error:g}=P(),h=async()=>{try{if(i(!0),console.log("Snap script status:",{isLoaded:p,isLoading:n,snapError:u}),console.log("Window.snap available:",!!window.snap),console.log("Order payment status:",t.payment_status),!p){s("Snap script belum dimuat. Silakan coba lagi.");return}if(!window.snap){s("Snap script tidak tersedia. Silakan refresh halaman.");return}let a;t.payment_status==="pending"?(console.log("Payment status is pending, continuing existing payment..."),a=await y.continueMidtransPayment(t.id,o)):(console.log("Creating new payment..."),a=await y.createMidtransPayment(t.id,o)),console.log("Payment response:",a),a.success?(console.log("Payment token:",a.data.token),console.log("Token length:",a.data.token.length),console.log("Is existing payment:",a.data.is_existing),window.snap.pay(a.data.token,{onSuccess:r=>{console.log("Payment success:",r),l(r)},onPending:r=>{console.log("Payment pending:",r),l(r)},onError:r=>{console.log("Payment error:",r),s("Pembayaran gagal: "+(r.message||"Unknown error"))},onClose:()=>{console.log("Payment popup closed"),i(!1)}})):(console.log("Payment creation failed:",a.error),s(a.error||"Gagal membuat pembayaran Midtrans"))}catch(a){if(console.error("Midtrans payment error:",a),a.response?.data?.error?.includes("Payment session already exists")){console.log("Payment session already exists - this should not happen with new logic"),s("Sesi pembayaran sudah ada. Silakan coba lagi.");return}s(a.response?.data?.error||"Gagal membuat pembayaran Midtrans")}finally{i(!1)}};return u?e.jsxs(m,{severity:"error",sx:{mb:3},children:[e.jsx("strong",{children:"Error Loading Snap Script"}),e.jsx("br",{}),u]}):f?e.jsxs(m,{severity:"info",sx:{mb:3},children:[e.jsx("strong",{children:"Memuat Kurs Mata Uang..."}),e.jsx("br",{}),"Sedang memuat kurs mata uang untuk pembayaran."]}):g?e.jsxs(m,{severity:"error",sx:{mb:3},children:[e.jsx("strong",{children:"Error Kurs Mata Uang"}),e.jsx("br",{}),g]}):e.jsx(b,{children:e.jsx(S,{variant:"contained",size:"large",startIcon:c||n?e.jsx(k,{size:20,color:"inherit"}):e.jsx(j,{}),onClick:h,disabled:c||n||!p,fullWidth:!0,sx:{py:1.5,borderRadius:2,fontWeight:600,fontSize:"1rem",backgroundColor:"primary.main","&:hover":{backgroundColor:"primary.dark"},"&:disabled":{backgroundColor:"grey.300",color:"grey.500"}},children:c?"Memproses Pembayaran...":n?"Memuat Snap Script...":t.payment_status==="pending"?"Lanjutkan Pembayaran":"Bayar"})})}export{j as C,I as M};
