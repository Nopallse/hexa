import{al as q,am as K,p as N,a8 as Q,q as J,an as V,r as y,j as e,B as s,C as b,T as n,ao as I,ag as X,t as w,S as g,ak as O,N as W,A as Y}from"./index-CjRkbdsW.js";import{o as P}from"./orderApi-Cd6SrDyt.js";import{C as Z,M as ee}from"./MidtransPaymentButton-QCxCLCiY.js";import{u as ae}from"./useCurrencyConversion-CFRmtJpc.js";import{A as j}from"./Alert-CYapFDnR.js";import{B as ne}from"./Breadcrumbs-j1g_dcXs.js";import{H as re}from"./Home-C_Jl3ZFE.js";import{O as te}from"./Receipt-0CGW_age.js";import{A as se}from"./ArrowBack-Bm9waFzN.js";import{G as M}from"./Grid-Cqp2UiQA.js";import{C as k,a as _}from"./CardContent-bGHhza-V.js";const ie=q()(K((o,t)=>({payments:[],currentPaymentInfo:null,loading:!1,error:null,setPayments:r=>o({payments:r}),addPayment:r=>o(h=>({payments:[r,...h.payments]})),updatePayment:(r,h)=>o(p=>({payments:p.payments.map(d=>d.id===r?{...d,...h}:d),currentPaymentInfo:p.currentPaymentInfo?{...p.currentPaymentInfo,payments:p.currentPaymentInfo.payments.map(d=>d.id===r?{...d,...h}:d)}:null})),setCurrentPaymentInfo:r=>o({currentPaymentInfo:r}),setLoading:r=>o({loading:r}),setError:r=>o({error:r}),clearError:()=>o({error:null})}),{name:"payment-storage",partialize:o=>({payments:o.payments,currentPaymentInfo:o.currentPaymentInfo})}));function Pe(){const o=N(),{orderId:t}=Q(),r=J(),h=V(),[p,d]=y.useState(!0),[u,l]=y.useState(!1),[v,c]=y.useState(null),[i,z]=y.useState(null),[oe,C]=y.useState("midtrans"),[ce,L]=y.useState([]),[x,A]=y.useState(null),{formatPrice:S,loading:$,error:B}=ae(),[de,E]=y.useState(!1),{setCurrentPaymentInfo:le,addPayment:f}=ie(),D=a=>new Date(a).toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),G=async()=>{if(t)try{d(!0),c(null);const a=await P.getOrderById(t);if(a.success){if(z(a.data),a.data.payment_status==="paid"){r(`/orders/${t}`,{state:{message:"Order sudah dibayar"}});return}if(a.data.status==="cancelled"){c("Order sudah dibatalkan dan tidak dapat dibayar");return}}else c("Order tidak ditemukan")}catch(a){console.error("Error fetching order:",a),c(a.response?.data?.error||"Gagal memuat order")}finally{d(!1)}},R=async()=>{try{const a=await P.getPaymentMethods();a.success&&L(a.data)}catch(a){console.error("Error fetching payment methods:",a)}},T=async()=>{if(t)try{E(!0);const a=await P.getPaymentStatus(t);a.success&&(A(a.data),a.data.has_active_payment&&C(a.data.active_payment.payment_method))}catch(a){console.error("Error checking payment status:",a)}finally{E(!1)}},U=async()=>{if(t)try{l(!0);const a=await P.cancelActivePayment(t);a.success?(A(null),C("paypal"),c(null)):c(a.error||"Gagal membatalkan pembayaran")}catch(a){c(a.response?.data?.error||"Gagal membatalkan pembayaran")}finally{l(!1)}},F=async()=>{if(x?.active_payment)try{if(l(!0),x.active_payment.payment_method==="midtrans")if(window.snap)window.snap.pay(x.active_payment.payment_reference,{onSuccess:a=>{console.log("Payment success:",a),f(a),r(`/payment/success?order_id=${t}`,{state:{orderId:t}})},onPending:a=>{console.log("Payment pending:",a),f(a),r(`/payment/success?order_id=${t}`,{state:{orderId:t}})},onError:a=>{console.log("Payment error:",a),c("Pembayaran gagal: "+(a.message||"Unknown error")),l(!1)},onClose:()=>{console.log("Payment popup closed by user"),l(!1)}});else{const a=document.createElement("script");a.src="https://app.sandbox.midtrans.com/snap/snap.js",a.setAttribute("data-client-key","SB-Mid-client-UtRW_uI4F5Wz6Pv8Tq8TQ"),a.onload=()=>{window.snap.pay(x.active_payment.payment_reference,{onSuccess:m=>{console.log("Payment success:",m),f(m),r(`/payment/success?order_id=${t}`,{state:{orderId:t}})},onPending:m=>{console.log("Payment pending:",m),f(m),r(`/payment/success?order_id=${t}`,{state:{orderId:t}})},onError:m=>{console.log("Payment error:",m),c("Pembayaran gagal: "+(m.message||"Unknown error")),l(!1)},onClose:()=>{console.log("Payment popup closed by user"),l(!1)}})},a.onerror=()=>{c("Gagal memuat Snap script"),l(!1)},document.head.appendChild(a)}else c("Metode pembayaran ini tidak mendukung lanjutan pembayaran. Silakan batalkan dan buat pembayaran baru."),l(!1)}catch(a){console.error("Continue payment error:",a),c("Gagal melanjutkan pembayaran: "+(a.message||"Unknown error")),l(!1)}};if(y.useEffect(()=>{if(t){G(),R(),T();const a=h.state;a?.selectedPaymentMethod&&C(a.selectedPaymentMethod)}},[t,h.state]),p)return e.jsx(s,{sx:{minHeight:"100vh",py:4},children:e.jsx(b,{maxWidth:"xl",children:e.jsx(n,{children:"Loading..."})})});if($)return e.jsx(s,{sx:{minHeight:"100vh",py:4},children:e.jsx(b,{maxWidth:"xl",children:e.jsx(j,{severity:"info",sx:{maxWidth:600,mx:"auto"},children:"Memuat kurs mata uang..."})})});if(B)return e.jsx(s,{sx:{minHeight:"100vh",py:4},children:e.jsx(b,{maxWidth:"xl",children:e.jsxs(j,{severity:"error",sx:{maxWidth:600,mx:"auto"},children:["Gagal memuat kurs mata uang: ",B]})})});if(v||!i)return e.jsx(s,{sx:{minHeight:"100vh",py:4},children:e.jsx(b,{maxWidth:"xl",children:e.jsx(j,{severity:"error",sx:{maxWidth:600,mx:"auto"},children:v||"Order tidak ditemukan"})})});const H=i.total_amount+i.shipping_cost;return e.jsx(s,{sx:{minHeight:"100vh",py:4},children:e.jsxs(b,{maxWidth:"xl",children:[e.jsxs(ne,{sx:{mb:4},children:[e.jsxs(I,{component:"button",variant:"body2",onClick:()=>r("/"),sx:{display:"flex",alignItems:"center",textDecoration:"none",color:"text.secondary","&:hover":{color:"primary.main"}},children:[e.jsx(re,{sx:{mr:.5,fontSize:"1rem"}}),"Beranda"]}),e.jsxs(I,{component:"button",variant:"body2",onClick:()=>r("/orders"),sx:{display:"flex",alignItems:"center",textDecoration:"none",color:"text.secondary","&:hover":{color:"primary.main"}},children:[e.jsx(te,{sx:{mr:.5,fontSize:"1rem"}}),"Pesanan"]}),e.jsxs(I,{component:"button",variant:"body2",onClick:()=>r(`/orders/${i.id}`),sx:{display:"flex",alignItems:"center",textDecoration:"none",color:"text.secondary","&:hover":{color:"primary.main"}},children:["#",i.id.slice(-8).toUpperCase()]}),e.jsxs(n,{variant:"body2",color:"text.primary",sx:{display:"flex",alignItems:"center"},children:[e.jsx(X,{sx:{mr:.5,fontSize:"1rem"}}),"Pembayaran"]})]}),e.jsx(w,{startIcon:e.jsx(se,{}),onClick:()=>r(`/orders/${i.id}`),sx:{mb:4},children:"Kembali ke Detail Order"}),v&&e.jsx(j,{severity:"error",sx:{mb:4},onClose:()=>c(null),children:v}),e.jsxs(s,{sx:{mb:4},children:[e.jsxs(n,{variant:"h4",fontWeight:700,sx:{mb:1},children:["Pembayaran Order #",i.id.slice(-8).toUpperCase()]}),e.jsx(n,{variant:"body1",color:"text.secondary",children:"Pilih metode pembayaran yang paling nyaman untuk Anda"})]}),e.jsxs(M,{container:!0,spacing:4,children:[e.jsxs(M,{item:!0,xs:12,lg:8,children:[x?.has_active_payment&&e.jsx(k,{sx:{mb:4,border:"2px solid",borderColor:"warning.main"},children:e.jsxs(_,{children:[e.jsxs(g,{direction:"row",alignItems:"center",spacing:2,sx:{mb:2},children:[e.jsx(s,{sx:{color:"warning.main"},children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"})})}),e.jsx(n,{variant:"h6",fontWeight:600,color:"warning.main",children:"Sesi Pembayaran Aktif"})]}),e.jsxs(n,{variant:"body1",sx:{mb:2},children:["Anda sudah memiliki sesi pembayaran aktif dengan metode ",e.jsx("strong",{children:x.active_payment.payment_method}),". Sesi ini akan berakhir pada ",e.jsx("strong",{children:D(x.active_payment.expires_at)}),"."]}),e.jsxs(g,{direction:"row",spacing:2,children:[e.jsx(w,{variant:"outlined",color:"warning",onClick:U,disabled:u,startIcon:u?e.jsx(O,{size:16}):null,children:u?"Membatalkan...":"Batalkan Sesi Pembayaran"}),e.jsx(w,{variant:"contained",color:"warning",onClick:F,disabled:u,startIcon:u?e.jsx(O,{size:16}):null,children:u?"Membuka Pembayaran...":"Lanjutkan Pembayaran"})]})]})}),e.jsx(k,{sx:{mb:4},children:e.jsxs(_,{children:[e.jsx(n,{variant:"h6",fontWeight:600,sx:{mb:3},children:"Metode Pembayaran"}),e.jsx(s,{sx:{p:3,border:`2px solid ${o.palette.primary.main}`,borderRadius:2,backgroundColor:o.palette.primary.light+"10",transition:"all 0.2s ease"},children:e.jsxs(g,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(Z,{sx:{fontSize:"2rem",color:o.palette.primary.main}}),e.jsxs(s,{sx:{flex:1},children:[e.jsxs(g,{direction:"row",alignItems:"center",spacing:1,sx:{mb:.5},children:[e.jsx(n,{variant:"subtitle1",fontWeight:600,children:"Midtrans"}),e.jsx(s,{sx:{backgroundColor:o.palette.success.main,color:"white",px:1,py:.25,borderRadius:1,fontSize:"0.7rem",fontWeight:600},children:"Dipilih"})]}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Pembayaran aman dengan berbagai metode: Kartu Kredit/Debit, E-Wallet, Bank Transfer, dan lainnya"})]})]})})]})}),e.jsx(k,{children:e.jsxs(_,{children:[e.jsx(n,{variant:"h6",fontWeight:600,sx:{mb:3},children:"Pembayaran Midtrans"}),!x?.has_active_payment&&e.jsx(ee,{order:i,onSuccess:a=>{console.log("Midtrans payment success"),f(a)},onError:a=>c(a)}),x?.has_active_payment&&e.jsx(j,{severity:"warning",sx:{mt:2},children:e.jsxs(n,{variant:"body2",children:[e.jsx("strong",{children:"Sesi pembayaran aktif terdeteksi!"}),e.jsx("br",{}),"Anda sudah memiliki sesi pembayaran yang aktif. Batalkan sesi pembayaran untuk membuat pembayaran baru atau lanjutkan pembayaran yang sudah ada."]})})]})})]}),e.jsx(M,{item:!0,xs:12,lg:4,children:e.jsx(k,{sx:{position:"sticky",top:24},children:e.jsxs(_,{children:[e.jsx(n,{variant:"h6",fontWeight:600,sx:{mb:3},children:"Ringkasan Pembayaran"}),e.jsxs(s,{sx:{mb:3},children:[e.jsx(n,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Order ID"}),e.jsxs(n,{variant:"body1",fontWeight:600,children:["#",i.id.slice(-8).toUpperCase()]})]}),e.jsxs(s,{sx:{mb:3},children:[e.jsx(n,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Tanggal Order"}),e.jsx(n,{variant:"body1",fontWeight:600,children:D(i.created_at)})]}),e.jsx(W,{sx:{my:3}}),e.jsxs(g,{spacing:2,children:[e.jsxs(s,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(n,{variant:"body1",children:"Subtotal"}),e.jsx(n,{variant:"body1",fontWeight:600,children:S(i.total_amount)})]}),e.jsxs(s,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(n,{variant:"body1",children:"Biaya Pengiriman"}),e.jsx(n,{variant:"body1",fontWeight:600,children:S(i.shipping_cost)})]}),e.jsx(W,{}),e.jsxs(s,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(n,{variant:"h6",fontWeight:700,children:"Total Pembayaran"}),e.jsx(n,{variant:"h6",fontWeight:700,color:"primary.main",children:S(H)})]})]}),e.jsx(W,{sx:{my:3}}),e.jsxs(n,{variant:"subtitle1",fontWeight:600,sx:{mb:2},children:["Item (",i.order_items.length,")"]}),e.jsxs(g,{spacing:1,children:[i.order_items.slice(0,3).map(a=>{const m=a.product_variant.product.product_images?.[0]?.image_name;return e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:2,p:1,borderRadius:1,backgroundColor:"#f8f9fa"},children:[e.jsx(Y,{src:m||`https://placehold.co/40x40/9682DB/FFFFFF/png?text=${encodeURIComponent(a.product_variant.product.name)}`,alt:a.product_variant.product.name,sx:{width:40,height:40,borderRadius:1,flexShrink:0},variant:"rounded"}),e.jsxs(s,{sx:{flex:1,minWidth:0},children:[e.jsx(n,{variant:"body2",fontWeight:600,noWrap:!0,children:a.product_variant.product.name}),e.jsxs(n,{variant:"caption",color:"text.secondary",children:["Qty: ",a.quantity]})]})]},a.id)}),i.order_items.length>3&&e.jsxs(n,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",py:1},children:["dan ",i.order_items.length-3," item lainnya"]})]})]})})})]})]})})}export{Pe as default};
